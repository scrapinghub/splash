language: python
sudo: required
dist: trusty

branches:
    only:
        - master
        - /^\d\.\d+$/

python:
    - "2.7_with_system_site_packages"
    - "3.4_with_system_site_packages"

env:
    - SYSTEM_PACKAGES=true
    - SYSTEM_PACKAGES=false

matrix:
    exclude:
        - python: "2.7_with_system_site_packages"
          env: SYSTEM_PACKAGES=false

before_install:
    # install common packages
    - sudo apt-get install -y zlib1g-dev libssl-dev python-openssl lua5.2-dev

    # install QT5 & PyQT5
    - >
        if [[ "$SYSTEM_PACKAGES" == "true" ]]; then \
            sudo apt-get install qt5-default python3-pyqt5; \
        else \
            sudo dockerfiles/splash/provision.sh install_deps; \
            sudo dockerfiles/splash/provision.sh install_builddeps; \
            sudo dockerfiles/splash/provision.sh install_pyqt5; \
        fi

    # install Python packages
    - sudo chmod -R 777 $VIRTUAL_ENV
    - >
        if [[ "$SYSTEM_PACKAGES" == "true" ]]; then \
            sudo apt-get install python-twisted python-imaging python-psutil; \
        else \
            sudo dockerfiles/splash/provision.sh install_python_deps; \
        fi

    # install Python packages required for tests
    - >
        pip install -U \
            requests \
            jsonschema \
            strict-rfc3339 \
            pytest \
            pytest-cov \
            codecov

install:
    - python setup.py install

script:
    - py.test --version
    - py.test --cov=splash --doctest-modules --duration=50 splash

after_success:
    - codecov
